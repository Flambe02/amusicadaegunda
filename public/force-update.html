<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forcer la mise √† jour - A M√∫sica da Segunda</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
      background: linear-gradient(to bottom, #f9fafb, #e5e7eb);
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    h1 { color: #1f2937; margin-top: 0; }
    .status {
      padding: 15px;
      margin: 15px 0;
      border-radius: 8px;
      font-weight: 500;
    }
    .info { background: #dbeafe; color: #1e40af; }
    .success { background: #d1fae5; color: #065f46; }
    .error { background: #fee2e2; color: #991b1b; }
    .warning { background: #fef3c7; color: #92400e; }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin: 10px 5px;
    }
    button:hover { background: #2563eb; }
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    .logs {
      background: #f3f4f6;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #3b82f6;
      padding-left: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîÑ Forcer la mise √† jour</h1>
    <p>Cette page va forcer la mise √† jour du Service Worker et vider tous les caches.</p>
    
    <div id="status" class="status info">
      ‚è≥ Pr√™t √† d√©marrer la mise √† jour...
    </div>
    
    <button id="updateBtn" onclick="forceUpdate()">üöÄ Forcer la mise √† jour</button>
    <button onclick="location.href='/'">üè† Retour √† l'accueil</button>
    
    <div class="logs" id="logs"></div>
  </div>

  <script>
    const logs = [];
    
    function addLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString('pt-BR');
      const logEntry = `[${timestamp}] ${message}`;
      logs.push(logEntry);
      
      const logsDiv = document.getElementById('logs');
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.textContent = logEntry;
      logsDiv.appendChild(entry);
      logsDiv.scrollTop = logsDiv.scrollHeight;
      
      console.log(logEntry);
    }
    
    function updateStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      statusDiv.className = `status ${type}`;
      statusDiv.textContent = message;
    }
    
    async function forceUpdate() {
      const btn = document.getElementById('updateBtn');
      btn.disabled = true;
      
      try {
        addLog('üöÄ D√©but de la mise √† jour forc√©e');
        updateStatus('‚è≥ Mise √† jour en cours...', 'info');
        
        // 1. D√©sactiver tous les Service Workers
        if ('serviceWorker' in navigator) {
          addLog('üîç Recherche des Service Workers actifs...');
          const registrations = await navigator.serviceWorker.getRegistrations();
          
          if (registrations.length > 0) {
            addLog(`üìã ${registrations.length} Service Worker(s) trouv√©(s)`);
            
            for (const registration of registrations) {
              addLog(`üóëÔ∏è D√©sactivation du Service Worker: ${registration.scope}`);
              await registration.unregister();
            }
            
            addLog('‚úÖ Tous les Service Workers ont √©t√© d√©sactiv√©s');
          } else {
            addLog('‚ÑπÔ∏è Aucun Service Worker actif trouv√©');
          }
        }
        
        // 2. Vider tous les caches
        if ('caches' in window) {
          addLog('üîç Recherche des caches...');
          const cacheNames = await caches.keys();
          
          if (cacheNames.length > 0) {
            addLog(`üìã ${cacheNames.length} cache(s) trouv√©(s)`);
            
            for (const cacheName of cacheNames) {
              addLog(`üóëÔ∏è Suppression du cache: ${cacheName}`);
              await caches.delete(cacheName);
            }
            
            addLog('‚úÖ Tous les caches ont √©t√© vid√©s');
          } else {
            addLog('‚ÑπÔ∏è Aucun cache trouv√©');
          }
        }
        
        // 3. Vider localStorage
        addLog('üóëÔ∏è Vidage du localStorage...');
        localStorage.clear();
        addLog('‚úÖ localStorage vid√©');
        
        // 4. Vider sessionStorage
        addLog('üóëÔ∏è Vidage du sessionStorage...');
        sessionStorage.clear();
        addLog('‚úÖ sessionStorage vid√©');
        
        // 5. R√©enregistrer le Service Worker
        if ('serviceWorker' in navigator) {
          addLog('üîÑ R√©enregistrement du Service Worker...');
          const registration = await navigator.serviceWorker.register('/sw.js', {
            updateViaCache: 'none'
          });
          
          addLog('‚úÖ Service Worker r√©enregistr√©');
          
          // Forcer la mise √† jour
          if (registration.waiting) {
            addLog('üîÑ Service Worker en attente d√©tect√©, activation...');
            registration.waiting.postMessage({ type: 'SKIP_WAITING' });
          }
          
          await registration.update();
          addLog('‚úÖ Mise √† jour du Service Worker forc√©e');
        }
        
        addLog('üéâ Mise √† jour termin√©e avec succ√®s !');
        updateStatus('‚úÖ Mise √† jour termin√©e ! Rechargement dans 3 secondes...', 'success');
        
        // Recharger la page apr√®s 3 secondes
        setTimeout(() => {
          addLog('üîÑ Rechargement de la page...');
          window.location.href = '/';
        }, 3000);
        
      } catch (error) {
        addLog(`‚ùå Erreur: ${error.message}`, 'error');
        updateStatus(`‚ùå Erreur: ${error.message}`, 'error');
        console.error('Erreur lors de la mise √† jour:', error);
        btn.disabled = false;
      }
    }
    
    // Ajouter un message initial
    addLog('‚úÖ Page de mise √† jour charg√©e');
    addLog('‚ÑπÔ∏è Cliquez sur "Forcer la mise √† jour" pour commencer');
  </script>
</body>
</html>
